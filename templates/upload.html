{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <!-- LEFT: Dropzone + form -->
  <div class="card bg-base-100 shadow rounded-2xl border border-base-300">
    <div class="card-body">
      <h3 class="card-title">Upload an item</h3>

      <!-- playful rotating prompt -->
      <p id="pitch" class="text-base-content/70 mb-3">
        Drop a top to find its perfect bottoms, bag & vibe âœ¨
      </p>

      <!-- Dropzone -->
      <div id="dropzone"
           class="rounded-2xl border-2 border-dashed border-base-300 bg-base-200/60 p-6 cursor-pointer
                  hover:border-base-content/50 transition">
        <div class="flex items-center gap-3">
          <button type="button" class="btn btn-neutral btn-sm">BROWSEâ€¦</button>
          <span id="fileLabel" class="text-sm opacity-80">No file selected.</span>
        </div>
        <p class="mt-2 text-xs opacity-70">Tip: drag & drop a photo of a top, bottom, dress or accessory.</p>
        <input id="fileInput" name="file" type="file" accept="image/*" class="hidden">
      </div>

      <!-- Form submit -->
      <form id="uploadForm"
      method="post"
      action="{{ url_for('handle_upload') }}"
      enctype="multipart/form-data"
      class="mt-5"
      onsubmit="return startAnalyze();">
  <input id="realFile" name="file" type="file" accept="image/*" class="hidden" required>
  <button id="submitBtn" class="btn btn-primary w-full rounded-full" disabled>
    Analyze & Recommend
  </button>
</form>


      <div class="mt-3 text-xs text-base-content/60">
        Supported: JPG, JPEG, PNG, WEBP â€¢ We auto-fix rotation & compress for speed
      </div>
    </div>
  </div>

  <!-- RIGHT: live preview -->
  <div class="card bg-base-100 shadow rounded-2xl border border-base-300">
    <div class="card-body">
      <h3 class="card-title">Preview</h3>
      <div class="rounded-lg border border-base-300 bg-base-200/60 h-[420px] grid place-items-center overflow-hidden">
        <img id="preview" alt="Preview will appear here" class="max-h-[420px] max-w-full object-contain hidden" />
        <span id="placeholder" class="text-base-content/60 text-sm">Select a file to see a local preview.</span>
      </div>
    </div>
  </div>
</div>

<script>
  // rotating fun prompts
  (function() {
    const pitch = document.getElementById('pitch');
    const lines = [
  "Drop a top, bottom, scarf/dupatta, dressâ€”anything âœ¨",
  "Upload a kurta or saree blouse and get bottoms, bags & accessories ðŸ’ƒ",
  "Have a scarf or dupatta? Weâ€™ll style the full look ðŸ§£",
  "Jeans, skirts, jacketsâ€”drag & drop and weâ€™ll pair it ðŸª„"
];

    let i = 0;
    setInterval(() => { i = (i + 1) % lines.length; pitch.textContent = lines[i]; }, 2800);
  })();

  const dz = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');   // temporary chooser
  const realFile = document.getElementById('realFile');     // posted to Flask
  const fileLabel = document.getElementById('fileLabel');
  const submitBtn = document.getElementById('submitBtn');
  const preview = document.getElementById('preview');
  const placeholder = document.getElementById('placeholder');

  // open file picker when clicking the zone
  dz.addEventListener('click', () => fileInput.click());

  // drag & drop effects
  ;['dragenter','dragover'].forEach(ev =>
    dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('border-primary'); })
  );
  ;['dragleave','drop'].forEach(ev =>
    dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('border-primary'); })
  );

  dz.addEventListener('drop', e => {
    const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
    if (f) handleFile(f);
  });

  fileInput.addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) handleFile(f);
  });

  function handleFile(f) {
    if (!f.type.startsWith('image/')) {
      fileLabel.textContent = "Please choose an image file.";
      submitBtn.disabled = true;
      return;
    }
    // show name
    fileLabel.textContent = f.name;

    // live preview
    const url = URL.createObjectURL(f);
    preview.src = url;
    preview.classList.remove('hidden');
    placeholder.classList.add('hidden');

    // put the file into the formâ€™s real input so Flask receives it
    const dt = new DataTransfer();
    dt.items.add(f);
    realFile.files = dt.files;

    submitBtn.disabled = false;
  }
  function startAnalyze() {
    const realFile = document.getElementById('realFile');
    const btn = document.getElementById('submitBtn');
    if (!realFile.files || !realFile.files.length) {
      alert('Please choose an image first.');
      return false;
    }
    if (btn) {
      btn.disabled = true;
      btn.classList.add('btn-disabled');
      btn.textContent = 'Curating your lookâ€¦';
    }
    showLoading('Curating your lookâ€¦');   // <<< shows the overlay
    return true; // allow submit to proceed
  }
</script>
{% endblock %}
